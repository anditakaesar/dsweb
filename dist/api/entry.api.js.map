{"version":3,"sources":["../../src/api/entry.api.js"],"names":["entryRouter","Entry","db","post","req","res","process","nextTick","newEntry","body","userId","session","user","id","empty","create","then","ent","json","message","messageType","data","err","helper","logger","error","get","findAndCountAll","results","entries","rows","forEach","entry","i","push","count","errmsg","draw","parseInt","offset","start","limit","length","xOc","order","column","xOcName","columns","xOd","dir","where","Object","keys","query","Op","or","funct","validValue","no","numPrefix","like","name","qName","toLowerCase","Sequelize","fn","col","from","travelDate","gte","to","pop","and","lte","v","recordsTotal","recordsFiltered","editedEntry","findByPk","params","update","numCombined","destroy","result"],"mappings":"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","sourcesContent":["import { Router } from 'express'\r\nimport db from '../helper/db'\r\nimport helper from '../helper'\r\nimport { Op, Sequelize } from 'sequelize'\r\nimport FormatEntry from '../helper/entry'\r\nimport genError from '../helper/errorHelper'\r\n\r\nconst entryRouter = Router()\r\nconst { Entry } = db\r\n\r\nentryRouter.post('/', (req, res) => {\r\n  process.nextTick(() => {\r\n    let newEntry = FormatEntry(req.body)\r\n    newEntry.userId = req.session.user.id\r\n    delete newEntry.id\r\n    delete newEntry.empty\r\n\r\n    Entry.create(newEntry)\r\n      .then((ent) => {\r\n        res.json({\r\n          message: 'save success',\r\n          messageType: 'success',\r\n          data: FormatEntry(ent)\r\n        })\r\n      })\r\n      .catch((err) => {\r\n        helper.logger.error(err.message, genError(err, req))\r\n        res.json({\r\n          message: `error: ${err.message}`,\r\n          messageType: 'danger'\r\n        })\r\n      })\r\n\r\n  })\r\n})\r\n\r\nentryRouter.get('/all', (req, res) => {\r\n  process.nextTick(() => {\r\n    Entry.findAndCountAll()\r\n      .then((results) => {\r\n        let entries = []\r\n        results.rows.forEach((entry, i) => {\r\n          entries.push(FormatEntry(entry))\r\n        })\r\n        res.json({\r\n          message: 'all entries loaded',\r\n          entries,\r\n          count: results.count,\r\n        })\r\n      })\r\n      .catch((err) => {\r\n        helper.logger.error(err.message, genError(err, req))\r\n        res.json({\r\n          message: 'error',\r\n          errmsg: err.message,\r\n        })\r\n      })\r\n  })\r\n})\r\n\r\nentryRouter.post('/dt', (req, res) => {\r\n  process.nextTick(() => {\r\n    let draw = parseInt(req.body.draw, 10)\r\n    let offset = parseInt(req.body.start, 10)\r\n    let limit = parseInt(req.body.length, 10)\r\n    let xOc = parseInt(req.body.order[0].column, 10)\r\n    let xOcName = req.body.columns[xOc].data\r\n    let xOd = req.body.order[0].dir\r\n    let order = [[xOcName, xOd]]\r\n    let results = []\r\n    let where = {}\r\n    if (Object.keys(req.query).length != 0) {\r\n      // { no: '001', name: 'andita', from: '2021-07-23', to: '2021-07-24' }\r\n      where[Op.or] = []\r\n      if (helper.funct.validValue(req.query.no)) {\r\n        where[Op.or].push({\r\n          numPrefix: {\r\n            [Op.like]: `%${req.query.no}%`\r\n          }\r\n        })\r\n      }\r\n\r\n      if (helper.funct.validValue(req.query.name)) {\r\n        let qName = req.query.name.toLowerCase();\r\n        where[Op.or].push(\r\n          Sequelize.where(\r\n            Sequelize.fn('lower', Sequelize.col('granteeName')), { [Op.like]: `%${qName}%` }\r\n          )\r\n        )\r\n      }\r\n\r\n      if (helper.funct.validValue(req.query.from)) {\r\n        where[Op.or].push(\r\n          {\r\n            travelDate: {\r\n              [Op.gte]: req.query.from\r\n            }\r\n          }\r\n        )\r\n\r\n        if (helper.funct.validValue(req.query.to)) {\r\n          where[Op.or].pop()\r\n          where[Op.or].push(\r\n            {\r\n              travelDate: {\r\n                [Op.and]: [\r\n                  { [Op.gte]: req.query.from },\r\n                  { [Op.lte]: req.query.to }\r\n                ]\r\n              }\r\n            }\r\n          )\r\n        }\r\n\r\n      } else if (helper.funct.validValue(req.query.to)) {\r\n        where[Op.or].push(\r\n          {\r\n            travelDate: {\r\n              [Op.lte]: req.query.to\r\n            }\r\n          }\r\n        )\r\n      }\r\n\r\n    }\r\n\r\n    Entry.findAndCountAll(\r\n      {\r\n        where,\r\n        offset,\r\n        limit,\r\n        order,\r\n      }\r\n    )\r\n      .then((data) => {\r\n        data.rows.forEach((v, i) => {\r\n          results.push(FormatEntry(v))\r\n        })\r\n        // console.log('ENTRY', results)\r\n        res.json({\r\n          draw,\r\n          recordsTotal: data.count,\r\n          recordsFiltered: data.count,\r\n          data: results\r\n        })\r\n      })\r\n      .catch((err) => {\r\n        helper.logger.error(err.message, genError(err, req))\r\n        res.json({\r\n          message: 'error',\r\n          errmsg: err.message,\r\n        })\r\n      })\r\n  })\r\n})\r\n\r\nentryRouter.post('/:id', (req, res) => {\r\n  process.nextTick(() => {\r\n    let editedEntry = FormatEntry(req.body)\r\n    editedEntry.userId = req.session.user.id\r\n    delete editedEntry.id\r\n    delete editedEntry.empty\r\n\r\n    Entry.findByPk(req.params.id)\r\n      .then((entry) => {\r\n        entry.update(editedEntry)\r\n        res.json({\r\n          message: `Entry ${editedEntry.numCombined} updated`,\r\n          messageType: 'success',\r\n          data: editedEntry\r\n        })\r\n      })\r\n      .catch((err) => {\r\n        helper.logger.error(err.message, genError(err, req))\r\n        res.json({\r\n          message: 'error',\r\n          errmsg: err.message,\r\n        })\r\n      })\r\n  })\r\n})\r\n\r\nentryRouter.get('/:id', (req, res) => {\r\n  process.nextTick(() => {\r\n    Entry.findByPk(req.params.id)\r\n      .then((entry) => {\r\n        let data = FormatEntry(entry)\r\n        res.json({\r\n          message: 'entry loaded',\r\n          messageType: 'primary',\r\n          data,\r\n        })\r\n      })\r\n      .catch((err) => {\r\n        helper.logger.error(err.message, genError(err, req))\r\n        res.json({\r\n          message: 'error',\r\n          errmsg: err.message,\r\n        })\r\n      })\r\n  })\r\n})\r\n\r\nentryRouter.delete('/:id', (req, res) => {\r\n  process.nextTick(() => {\r\n    Entry.destroy({\r\n      where: {\r\n        id: req.params.id\r\n      }\r\n    })\r\n      .then((result) => {\r\n        res.json({\r\n          message: `entry with id ${req.params.id} deleted!`,\r\n          messageType: 'danger',\r\n        })\r\n      })\r\n      .catch((err) => {\r\n        helper.logger.error(err.message, genError(err, req))\r\n        res.json({\r\n          message: 'error',\r\n          errmsg: err.message,\r\n        })\r\n      })\r\n  })\r\n})\r\n\r\nexport default entryRouter"],"file":"entry.api.js"}