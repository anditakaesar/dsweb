{"version":3,"sources":["../../src/routers/edit.js"],"names":["editRouter","Entry","db","Position","TravelType","puppeteer","require","getPosition","req","res","next","data","position","findAll","then","posdata","forEach","pos","i","push","err","helper","logger","error","message","json","getTravelType","travelType","travdata","trav","getPositionName","entry","fieldNames","find","p","positionCode","positionName","getTravelTypeName","trv","t","id","travelLengthType","travelName","formatDate","rawStrDate","formatStr","rawDate","format","getEntries","entries","process","nextTick","arrIds","query","ids","split","length","where","Op","ent","render","user","session","use","role","ROLES","STAFF","get","createPDF","templateHtml","fs","readFileSync","path","join","cwd","template","handlebars","compile","loadedEntry","grantorPosition","granteePosition","travelDate","travelDateBack","travelArrivalDate","html","launch","args","headless","browser","newPage","page","waitUntil","pdf","close","mergePdf","pdfsToMerge","singlePdf","PDFDocument","create","mergedPdf","pdfBytes","load","copyPages","getPageIndices","copiedPages","addPage","save","buf","buffer","merged","set","send","Buffer","from","errmsg","findByPk","params"],"mappings":"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","sourcesContent":["import { Router } from 'express'\r\nimport { ROLES } from '../helper/constants/roles'\r\nimport db from '../helper/db'\r\nimport FormatEntry, { FormatPDFName, FormatPosition, FormatTravelType } from '../helper/entry'\r\nimport handlebars from 'handlebars'\r\nimport fs from 'fs'\r\nimport path from 'path'\r\nimport moment from 'moment'\r\nimport { Op } from 'sequelize'\r\nimport { PDFDocument } from 'pdf-lib'\r\nimport helper from '../helper'\r\nimport genError from '../helper/errorHelper'\r\n\r\nconst editRouter = Router()\r\nconst { Entry, Position, TravelType } = db\r\nconst puppeteer = require('puppeteer')\r\n\r\nexport const getPosition = (req, res, next) => {\r\n  res.data.position = []\r\n  Position.findAll()\r\n    .then((posdata) => {\r\n      posdata.forEach((pos, i) => {\r\n        res.data.position.push(FormatPosition(pos))\r\n      })\r\n      next()\r\n    })\r\n    .catch((err) => {\r\n      helper.logger.error(err.message, genError(err, req))\r\n      res.json({\r\n        message: 'Error edit/getPosition',\r\n        error: err\r\n      })\r\n    })\r\n}\r\n\r\nconst getTravelType = (req, res, next) => {\r\n  res.data.travelType = []\r\n  TravelType.findAll()\r\n    .then((travdata) => {\r\n      travdata.forEach((trav, i) => {\r\n        res.data.travelType.push(FormatTravelType(trav))\r\n      })\r\n      next()\r\n    })\r\n    .catch((err) => {\r\n      helper.logger.error(err.message, genError(err, req))\r\n      res.json({\r\n        message: 'Error edit/getPosition',\r\n        error: err\r\n      })\r\n    })\r\n}\r\n\r\nexport const getPositionName = (entry, fieldNames, position = []) => {\r\n  let pos = position.find(p => p.positionCode == entry[fieldNames])\r\n  return pos ? pos.positionName : \"\"\r\n}\r\n\r\nconst getTravelTypeName = (entry, travelType = []) => {\r\n  let trv = travelType.find(t => t.id == entry.travelLengthType)\r\n  return trv ? trv.travelName : \"\"\r\n}\r\n\r\nconst formatDate = (rawStrDate, formatStr = 'DD-MM-YYYY') => {\r\n  let rawDate = moment(rawStrDate)\r\n  return rawDate.format(formatStr)\r\n}\r\n\r\nconst getEntries = (req, res, next) => {\r\n  res.data.entries = []\r\n  process.nextTick(() => {\r\n    let arrIds = req.query.ids.split(',')\r\n    if (arrIds.length > 0) {\r\n      Entry.findAll({\r\n        where: {\r\n          id: { [Op.in]: arrIds }\r\n        }\r\n      })\r\n        .then((data) => {\r\n          data.forEach((ent, i) => {\r\n            res.data.entries.push(FormatEntry(ent))\r\n          })\r\n          next()\r\n        })\r\n        .catch((err) => {\r\n          helper.logger.error(err.message, genError(err, req))\r\n          res.json({\r\n            message: 'error on edit/getEntries',\r\n            error: err\r\n          })\r\n        })\r\n\r\n    } else {\r\n      res.data.message = 'No data selected'\r\n      res.render('error', {\r\n        data: {\r\n          ...res.data,\r\n          user: req.session.user,\r\n        }\r\n      })\r\n    }\r\n  })\r\n}\r\n\r\neditRouter.use((req, res, next) => {\r\n  if (req.session.user.role === ROLES.STAFF) {\r\n    next()\r\n  } else {\r\n    res.data.message = 'Unauthorized'\r\n    res.render('error', {\r\n      data: {\r\n        ...res.data,\r\n        user: req.session.user,\r\n      }\r\n    })\r\n  }\r\n}, getPosition, getTravelType)\r\n\r\neditRouter.get('/', (req, res) => {\r\n  res.render('edit', {\r\n    data: {\r\n      ...res.data,\r\n      user: req.session.user,\r\n    }\r\n  })\r\n})\r\n\r\neditRouter.get('/list', (req, res) => {\r\n  res.render('edit-listing', {\r\n    data: {\r\n      ...res.data,\r\n      user: req.session.user,\r\n    }\r\n  })\r\n})\r\n\r\nasync function createPDF(entry, res) {\r\n  let templateHtml = fs.readFileSync(path.join(process.cwd(), 'views', 'doc_template.hbs'), 'utf-8')\r\n  let template = handlebars.compile(templateHtml)\r\n  let loadedEntry = FormatEntry(entry)\r\n  loadedEntry.grantorPosition = getPositionName(entry, 'grantorPosition', res.data.position)\r\n  loadedEntry.granteePosition = getPositionName(entry, 'granteePosition', res.data.position)\r\n  loadedEntry.travelLengthType = getTravelTypeName(entry, res.data.travelType)\r\n  loadedEntry.travelDate = formatDate(loadedEntry.travelDate)\r\n  loadedEntry.travelDateBack = formatDate(loadedEntry.travelDateBack)\r\n  loadedEntry.travelArrivalDate = formatDate(loadedEntry.travelArrivalDate)\r\n  let html = template(loadedEntry)\r\n\r\n  const browser = await puppeteer.launch({ args: ['--no-sandbox'], headless: true })\r\n  let page = await browser.newPage();\r\n  await page.goto(`data:text/html;charset=UTF-8,${html}`, {\r\n    waitUntil: 'networkidle0'\r\n  })\r\n\r\n  const pdf = await page.pdf()\r\n  await browser.close()\r\n\r\n  return pdf\r\n}\r\n\r\nasync function mergePdf(entries = [], res) {\r\n  if (entries.length > 0) {\r\n    let pdfsToMerge = []\r\n    for (const entry of entries) {\r\n      let singlePdf = await createPDF(entry, res)\r\n      pdfsToMerge.push(singlePdf)\r\n    }\r\n    const mergedPdf = await PDFDocument.create()\r\n    for (const pdfBytes of pdfsToMerge) {\r\n      const pdf = await PDFDocument.load(pdfBytes)\r\n      const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices())\r\n      copiedPages.forEach((page) => {\r\n        mergedPdf.addPage(page)\r\n      })\r\n    }\r\n\r\n    const buf = await mergedPdf.save()\r\n    return buf.buffer\r\n  } else {\r\n    return null\r\n  }\r\n}\r\n\r\neditRouter.get('/pdf/combined', getEntries, (req, res) => {\r\n  // res.data.entries\r\n  process.nextTick(() => {\r\n    mergePdf(res.data.entries, res)\r\n      .then((merged) => {\r\n        res.set({\r\n          'Content-Type': 'application/pdf',\r\n          'Content-Length': merged.length,\r\n          'Content-disposition': `inline; filename=${moment().format(\"YYYYMMDD\")}_SURAT_PERINTAH_PERJALANAN_DINAS_combined.pdf`\r\n        })\r\n        res.send(Buffer.from(merged, 'utf8'))\r\n      })\r\n      .catch((err) => {\r\n        helper.logger.error(err.message, genError(err, req))\r\n        res.json({\r\n          message: 'error',\r\n          errmsg: err.message,\r\n        })\r\n      })\r\n  })\r\n})\r\n\r\neditRouter.get('/pdf/:id', (req, res) => {\r\n  process.nextTick(() => {\r\n\r\n    Entry.findByPk(req.params.id)\r\n      .then((entry) => {\r\n        createPDF(entry, res)\r\n          .then((pdf) => {\r\n            res.set({\r\n              'Content-Type': 'application/pdf',\r\n              'Content-Length': pdf.length,\r\n              'Content-disposition': `inline; filename=${FormatPDFName(entry)}`\r\n            })\r\n            res.send(pdf)\r\n          })\r\n          .catch((err) => {\r\n            helper.logger.error(err.message, genError(err, req))\r\n            res.json({\r\n              message: 'error',\r\n              errmsg: err.message,\r\n            })\r\n          })\r\n\r\n      })\r\n      .catch((err) => {\r\n        helper.logger.error(err.message, genError(err, req))\r\n        res.json({\r\n          message: 'error',\r\n          errmsg: err.message,\r\n        })\r\n      })\r\n\r\n  })\r\n})\r\n\r\nexport default editRouter"],"file":"edit.js"}